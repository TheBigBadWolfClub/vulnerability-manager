import React from "react";
import TextField from "@material-ui/core/TextField";
import TextareaAutosize from "@material-ui/core/TextareaAutosize";
import {getSimplifiedVulnerability} from "../../graphql/vulnerability";
import {fetchWrapper} from "../../graphql/ApiService";
import CustomDivider from "./CustomDivider";
import Button from "@material-ui/core/Button";
import ViewGenericScoresBar from "./ViewGenericScoresBar";
import {cvssScoresFields} from "../../graphql/Cvss"

export default function GenericEdit(props) {
  const vulnerabilityId = props.vulnerabilityId;
  const editMode = props.editMode;
  const [data, setData] = React.useState({})


  React.useEffect(() => {
    fetchWrapper(getSimplifiedVulnerability(vulnerabilityId, `cveId title description ${cvssScoresFields}`))
      .then(resData => {
        const vulnerability = resData.data.getVulnerability;
        setData(vulnerability);
        console.log(data)
      }).catch(err => {
      console.log(err)
    })
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);


  const onChangeFn = (event) => {
    const {name, value} = event.target;
    console.log(event.target.value);
    setData(prev => {
      return {...prev, [name]: value}
    })
    // this.setValue({value: value});
  }


  const submitChanges = (event) => {
    event.preventDefault()
    const requestBody = {
      query: `
      mutation {
        updateGenericData(id: "${vulnerabilityId}", title: "${data.title}", description: "${data.description}") {
          title
          description
        }
      }
      `
    }
    fetchWrapper(requestBody)
      .then(resData => {
        const res = resData.data.updateGenericData;
        setData(prevState => {
          return {...prevState, title: res.title, description: res.description}
        });
        console.log(data)
      }).catch(err => {
      console.log(err)
    })

  }


  return (
    <React.Fragment>
      {!editMode && <ViewGenericScoresBar
        scoresData={data.cvssScores}
        editMode={editMode}
      />}
      <form className={`view-edit-form`}>
        <TextField id="cveId" label="CVE-ID" className={`view-edit-elm view-edit-id`}
                   value={data.cveId + ' '}
                   onChange={onChangeFn}
                   InputProps={{
                     readOnly: true,
                     disableUnderline: true,
                   }}
        />
        <TextField id="title" label="Title" className={'view-edit-title view-edit-elm'}
                   value={data.title + ' '}
                   onChange={onChangeFn}
                   name={'title'}
                   InputProps={{
                     readOnly: !editMode,
                     disableUnderline: !editMode,
                   }}/>
        <div className={'view-edit-elm'}>
          <label>Description</label>
          {editMode && <TextareaAutosize id="description" label="description" name={'description'}
            rowsMin={3}
            defaultValue={data.description} onChange={onChangeFn}/>
          }
          {!editMode && <p>{data.description}</p>}

        </div>
      </form>
      {editMode && <section>
        <CustomDivider/>
        <div className={"action-button-save"}>
          <Button variant="contained" color="primary" size="small" onClick={submitChanges}>
            Save
          </Button>
        </div>
      </section>
      }

    </React.Fragment>
  )
}
